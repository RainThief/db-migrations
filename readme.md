# Database migrations

This project will allow database migrations both forward and backward with an ability to seed with data.

## Requirements

To run migrations and seeding you will need

* [Docker](https://docs.docker.com/get-docker/)
* Bash
  * [WSL](https://docs.microsoft.com/en-us/windows/wsl/install-win10)
  * [Cygwin](https://www.cygwin.com/)

## Creating migrations

Migrations should be created with the `create_migration.sh` command which will enforce a naming convention of `timestamp_git-hash_revision-name` to the version file.  Alternatively a migration can be created manually with the [alembic revision](hhttps://alembic.sqlalchemy.org/en/latest/tutorial.html#create-a-migration-script) command.

```shell
$ ./create_migration.sh --name test_migration

Generating /usr/app/migrations/versions/2020_09_29T15_48_54__b6f7f78__test_migration.py ...  done
```

### Auto generate

Revision files may also be auto generated by comparing a database state to the current ORM models declared.  For this to happen you will need to pass in database connection arguments or [set env vars](#setting-env-vars).  To run manually with alembic you will need to create an [`alembic.ini`](https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file) config file in project root.

You must ensure that all model modules you wish to be used for auto generate are imported in `migrations/env.py` file

```shell
$ ./create_migration.sh --name test -g -u user -p pass -d db -h localhost

INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.ddl.postgresql] Detected sequence named 'accounts_user_id_seq' as owned by integer column 'accounts(user_id)', assuming SERIAL and omitting
INFO  [alembic.autogenerate.compare] Detected NULL on column 'accounts.email'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'accounts.password'
INFO  [alembic.autogenerate.compare] Detected NULL on column 'accounts.username'
INFO  [alembic.autogenerate.compare] Detected removed unique constraint 'accounts_email_key' on 'accounts'
INFO  [alembic.autogenerate.compare] Detected removed unique constraint 'accounts_username_key' on 'accounts'
INFO  [alembic.autogenerate.compare] Detected removed column 'accounts.last_login'
INFO  [alembic.autogenerate.compare] Detected removed column 'accounts.created_on'
  Generating /usr/app/migrations/versions/2020_09_29T16_00_06__b6f7f78__localhost.py ...  done
```

For documentation on writing migration scripts please visit [alembic documentation](https://alembic.sqlalchemy.org/en/latest/tutorial.html#create-a-migration-script).  The migration scripts generated in this project will also allow for a seed method so that you may pre-populate your migration with data.

## Running migrations

To migrate your database you should use the `./run_action` command with arguments for `migrate`, `direction up|down` and the `version id` to migrate to.  Special version id's are `head` and `base` for migration to the latest or first version states.  You will need to pass in database connection arguments or [set env vars](#setting-env-vars).

```shell
$ ./run_action.sh -u user -p pass -h localhost -d dbname -D postgresql migrate up head

INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 2020_09_01T12_51_35, accounts
```

## Creating seeds

Seeds are classes that allow for pre-populating of data.  Seeds are useful for filling a database with dummy data for developing and testing purposes.  To create a new seeder class use the `./create_seeder.sh` command.

```shell
$ ./create_seeder.sh --name TestSeeder

./seeds/test_seeder.py created
```

Using SQL or [SQLAlchemy](https://docs.sqlalchemy.org/en/13/orm/tutorial.html#adding-and-updating-objects) write seeding logic in the `run` method.  For this seeding class to be called you will need to import this seeder in `scripts/run_seeders.py` file in call in the `run` method.

## Running seeds

As a safeguard seeding will not occur unless the environment variable `SEED` is set to `true`.  It is advised to set this variable when running a seeding operation and not pre-populate with [`~/.profile`](#setting-env-vars).  You will need to pass in database connection arguments or [set env vars](#setting-env-vars).


```shell
$ export SEED=true
$ ./run_action.sh -u user -p pass -h localhost -d dbname -D postgresql seed

database successfully seeded
```

## Creating models

If using [auto generate](#auto-generate) feature to create migrations from model changes, you will need to edit or create [models](https://docs.sqlalchemy.org/en/13/orm/mapping_styles.html#declarative-mapping) in the `orm/models` module.

## Setting env vars

To save entering arguments with commands to provide database connection details you may set environment variable with the connection information.  For convenience you may wish to set this in your `~/.bash_profile` or `~/.profile` files.

```shell
export DB_URL="driver://user:pass@localhost:port/dbname"
```

## Development

This project uses Docker to run but if you wish to develop functionality you will require [Python 3.8+](https://www.python.org/downloads/) and install the requirements

```shell
pip install -r requirements.txt
```

### Project structure

#### `/migrations`

This is the alembic installation folder.

#### `/migrations/versions`

Migrations or versions files.  These need to be created and edited for each new migration.

#### `/orm`

ORM is a Python sub package.  This package contains the [SQLAlchemy](https://www.sqlalchemy.org/) models in the `models` module.  Models are only used in this project for [auto generation](#auto-generate) of migration files

By having models as a sub package they can be imported by PIP into any project that uses this database so they need not be re-created and maintained in two or more locations.

Installation via PIP and Git

```shell
pip install git+https://github.com/<github path>@<branch or commit>#subdirectory=orm`
```

#### `/scripts`

Scripts to perform various build, install, analysis, etc operations.

#### `/seeds`

Seeder classes to populate database with data.  Useful for inserting dummy data for testing.

#### `/util`

Utilities for the proper functioning of this project.

### Commands

#### `$ ./run_audit.sh`

Checks third party dependencies for

* Compatible licenses
* Security vulnerabilities
* Updated versions

Example output

```shell
+==============================================================================+
|                                                                              |
|                               /$$$$$$            /$$                         |
|                              /$$__  $$          | $$                         |
|           /$$$$$$$  /$$$$$$ | $$  \__//$$$$$$  /$$$$$$   /$$   /$$           |
|          /$$_____/ |____  $$| $$$$   /$$__  $$|_  $$_/  | $$  | $$           |
|         |  $$$$$$   /$$$$$$$| $$_/  | $$$$$$$$  | $$    | $$  | $$           |
|          \____  $$ /$$__  $$| $$    | $$_____/  | $$ /$$| $$  | $$           |
|          /$$$$$$$/|  $$$$$$$| $$    |  $$$$$$$  |  $$$$/|  $$$$$$$           |
|         |_______/  \_______/|__/     \_______/   \___/   \____  $$           |
|                                                          /$$  | $$           |
|                                                         |  $$$$$$/           |
|  by pyup.io                                              \______/            |
|                                                                              |
+==============================================================================+
| REPORT                                                                       |
| checked 34 packages, using default DB                                        |
+==============================================================================+
| No known security vulnerabilities found.                                     |
+==============================================================================+
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   303  100   303    0     0   1109      0 --:--:-- --:--:-- --:--:--  1105
 Name               Version    License
 python-dateutil    2.8.1      Dual License
licence checker warning
PLEASE REVIEW LICENSES LISTED ABOVE
Security audit passed
```

#### `$ ./run_static_analysis.sh`

Example output

```shell
linting python
linting bash
linting dockerfile
Static analysis passed
```

#### `$ ./run_system_tests.sh`

@todo

#### `$ ./run_unit_tests.sh`

Example output

```shell
collected 12 items

scripts/test_create_seeder.py ........                        [ 66%]
scripts/test_run_seeders.py ..                                [ 83%]
util/test_seeder.py ..                                        [100%]

===================== 12 passed in 2.29s ===========================
```

### Speed up CI

To speed up Github actions you can pre build the ci support docker image (`scripts/Dockerfile`) and push to a registry.  Then set up an environment variable of `$CI_IMAGE` with the docker image location to be pulled and used.
By using a pre built image will prevent github actions building an image on every run.
